---
title: "ESG Covariate Processing"
author: "Jonathan Maynard"
date: "Feb 10, 2017"
output: html_document
---

## Overview
#### This script downloads and processes a wide range of spatial covariate layers
```{r eval=FALSE}
required.packages <- c("here", "MODIS", "maptools", "rgdal", "raster", "maps", "lubridate", "sp", "gdalUtils", "prodlim", "Cairo", "lattice", "zoo", "rgeos", "shapefiles", "spatial.tools", "ggplot2", "rasterVis", "stringdist", "data.table", "fastmatch", "pROC", "parallel", "foreach", "plyr", "snowfall", "imputeTS", "signal", "dummies", "gtools", "doParallel")
new.packages <- required.packages[!(required.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(required.packages, require, character.only=T)
rm(required.packages, new.packages)


no_cores <- detectCores() - 1  
cl <- makeCluster(no_cores, type="SOCK", outfile = "")  
registerDoParallel(cl)  
getDoParWorkers()
```


## NASIS ES Point Data
####Load in NASIS ecological site point data
```{r eval=FALSE}
#Study areas
CO <- readOGR(dsn="/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/CO_Plat_study_area",layer="epaL4_mlra35sel_bndc")
NM <- readOGR(dsn="/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/Chihuahuan_study_area",layer="Chihauhuan_Study_Area_Boundary")

CO.shapepath <- "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/CO_Plat_study_area/epaL4_mlra35sel_bndc.shp"
NM.shapepath <- "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/Chihuahuan_study_area/Chihauhuan_Study_Area_Boundary.shp"

# CO rasterize Set up a raster 'template' to use in rasterize()
ext.co <- extent(CO)
xy.co <- abs(apply(as.matrix(bbox(CO)), 1, diff))
r.co <- raster(ext.co, ncol = xy.co[1]/250, nrow = xy.co[2]/250)

# Rasterize the shapefile
CO_raster <- rasterize(CO, r.co)
res(CO_raster) <- 250
plot(CO_raster)

# NM rasterize Set up a raster 'template' to use in rasterize()
ext.nm <- extent(NM)
xy.nm <- abs(apply(as.matrix(bbox(NM)), 1, diff))
r.nm <- raster(ext.nm, ncol = xy.nm[1]/250, nrow = xy.nm[2]/250)

# Rasterize the shapefile
NM_raster <- rasterize(NM, r.nm)
res(NM_raster) <- 250
plot(NM_raster)

#---------------------------------------------------------------------------------------------------------------------
# CO points #
co.nasis <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/nasis35_ESGs", layer = "nasis35_esdjn_esgjn")
co.nasis.edit <- co.nasis[co.nasis@data$ESG_number!=0, ]

# look at esite class distribution
co.esite.dist <- plyr::count(co.nasis.edit@data$ESG_Name)
par(mar = c(10.5, 4, 3.5, 4))
mp <- barplot(co.esite.dist$freq, axes = FALSE, axisnames = FALSE)
text(mp, par("usr")[3], labels = co.esite.dist$x, srt = 45, adj = c(1.1, 1.1), xpd = TRUE, cex = 0.9)
axis(2)
# Project using spTransform
co.points <- spTransform(co.nasis.edit, crs(CO))
co.points@data$ESG_ID <- paste0("ES", co.points$ESG_number)
writeOGR(co.points, dsn = "/data/data2/data/esgMapping/analysis/data/derived_data/vector_data", layer = "CO_points_final", driver = "ESRI Shapefile", overwrite_layer = TRUE)

#---------------------------------------------------------------------------------------------------------------------
# NM points #
nm.nasis <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/nasis42_ESDs", layer = "nasis42_esdjn")
nm.nasis.edit <- nm.nasis[is.na(nm.nasis@data$First_ecoc) == FALSE, ]
# rite out to manually assign look-up table values to NASIS ESD values
write.csv(unique(nm.nasis.edit@data$First_ecoc), "nm_nasis_unique_ESD.csv")
# remove: 'Basalt Hill, Mixed Prairie', 'Gyp Breaks, Desert Grassland', 'Arroyo, Hot Desert Shrub'
nm.nasis.edit <- nm.nasis.edit[nm.nasis.edit@data$First_ecoc != "Basalt Hill, Mixed Prairie", ]
nm.nasis.edit <- nm.nasis.edit[nm.nasis.edit@data$First_ecoc != "Gyp Breaks, Desert Grassland", ]
nm.nasis.edit <- nm.nasis.edit[nm.nasis.edit@data$First_ecoc != "Arroyo, Hot Desert Shrub", ]
nm.lookup <- read.csv("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/MLRA42_NASIS_ESG_lookup.csv",
    header = T)
nm.nasis.edit.data <- nm.nasis.edit@data
colnames(nm.nasis.edit.data)[9] <- "NASIS_ESD"
nm.nasis.edit.data.join <- join(nm.nasis.edit.data, nm.lookup)
nm.nasis.edit@data <- nm.nasis.edit.data.join
# look at esite class distribution
nm.esite.dist <- plyr::count(nm.nasis.edit@data$X2016_Esite_Group)
par(mar = c(10.5, 4, 3.5, 4))
mp <- barplot(nm.esite.dist$freq, axes = FALSE, axisnames = FALSE)
text(mp, par("usr")[3], labels = nm.esite.dist$x, srt = 45, adj = c(1.1, 1.1), xpd = TRUE, cex = 0.9)
axis(2)
# Project using spTransform
nm.points <- spTransform(nm.nasis.edit,  crs(CO))
nm.points@data$ESG_ID <- paste0("ES", nm.points$ESG_mun)

writeOGR(nm.points, dsn = "/data/data2/data/esgMapping/analysis/data/derived_data/vector_data", layer = "NM_points_final", driver = "ESRI Shapefile", overwrite_layer = TRUE)

#---------------------------------------------------------------------------------------------------------------------
#create esite df with site index
co.site_id <- data.frame(seq(1,nrow(co.points),1), co.points$ESG_ID)
names(co.site_id) <- c("Index", "esite")

nm.site_id <- data.frame(seq(1,nrow(nm.points),1), nm.points$ESG_ID)
names(nm.site_id) <- c("Index", "esite")
#---------------------------------------------------------------------------------------------------------------------
```

## Process Covariate Data
### Terrain Data
```{r eval=FALSE}
#Raster Layers
path.terrain.nm <- "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/MLRA42_topo"
terrain.nm <- preStack(path = path.terrain.nm, pattern = "*.tif$")
terrain.nm_list <- unstack(stack(terrain.nm))
terrain.nm.names <- sapply(strsplit(basename(terrain.nm), split = ".", fixed = TRUE), function(x) (x[1]))
terrain.nm.stack <- stack(terrain.nm)
path.terrain.co <- "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/MLRA35_topo/NadAlb250"
terrain.co <- preStack(path = path.terrain.co, pattern = "*.tif$")
terrain.co_list <- unstack(stack(terrain.co))
terrain.co.names <- sapply(strsplit(basename(terrain.co), split = ".", fixed = TRUE), function(x) (x[1]))
terrain.co.stack <- stack(terrain.co)

#---------------------------------------------------------------------------------------------------------------------
#Copy Raster Covariates
file.copy(terrain.co, "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO/")
file.copy(terrain.nm, "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM/")
terrain.co.copy <- preStack(path = "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO/", pattern = "*.tif$")
```

### Lithology Data
```{r eval=FALSE}
#Raster Layers
co.glim.latlon <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/NM_CO_GLiM",
    layer = "GLiM_CO")
co.glim <- spTransform(co.glim.latlon, crs(CO))
nm.glim.latlon <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/NM_CO_GLiM",
    layer = "GLiM_NM")
nm.glim <- spTransform(nm.glim.latlon, crs(CO))

## Set up a raster 'template' to use in rasterize()

# Colorado Palteau
co.ext <- extent(co.glim)
co.xy <- abs(apply(as.matrix(bbox(co.glim)), 1, diff))
co.r <- raster(co.ext, ncol = co.xy[1]/250, nrow = co.xy[2]/250)
res(co.r) <- 250
system.time(co_litho_raster <- rasterize(co.glim, co.r, "xx"))
writeRaster(co_litho_raster, filename = "/data/data2/data/esgMapping/analysis/data/derived_data/raster_layers/CO_litho.tif",
    format = "GTiff", overwrite = T)
co_litho_raster.layer <- layerize(co_litho_raster, filename = "/data/data2/data/esgMapping/analysis/data/derived_data/raster_layers/CO_litho_layer.tif",
    format = "GTiff", overwrite = T)
names(co_litho_raster.layer) <- paste0("lithology_", levels(co.glim$xx))
co_litho_raster.layer <- projectRaster(co_litho_raster.layer, crs=crs(CO))

redblue <- colorRampPalette(c("tomato4", "yellow2", "chartreuse4", "blue2"))
cbPalette <- redblue(11)
co_litho_raster_plot <- gplot(co_litho_raster, maxpixels = 8e+05) + geom_raster(aes(fill = factor(value))) +
    coord_equal() + labs(x = "Easting (m)", y = "Northing (m)", fill = "Lithology") + ggtitle("CO Lithology") +
    scale_fill_manual(values = cbPalette)
co_litho_raster_plot

# Chihuahuan Desert
nm.ext <- extent(nm.glim)
nm.xy <- abs(apply(as.matrix(bbox(nm.glim)), 1, diff))
nm.r <- raster(nm.ext, ncol = nm.xy[1]/250, nrow = nm.xy[2]/250)
res(nm.r) <- 250
system.time(nm_litho_raster <- rasterize(nm.glim, nm.r, "xx"))
writeRaster(nm_litho_raster, filename = "/data/data2/data/esgMapping/analysis/data/derived_data/raster_layers/NM_litho.tif",
    format = "GTiff", overwrite = T)
nm_litho_raster.layer <- layerize(nm_litho_raster, filename = "/data/data2/data/esgMapping/analysis/data/derived_data/raster_layers/NM_litho_layer.tif",
    format = "GTiff", overwrite = T)
names(nm_litho_raster.layer) <- paste0("lithology_", levels(nm.glim$xx))
nm_litho_raster.layer <- projectRaster(nm_litho_raster.layer, crs=crs(NM))

redblue <- colorRampPalette(c("tomato4", "yellow2", "chartreuse4", "blue2"))
cbPalette <- redblue(13)
nm_litho_raster_plot <- gplot(nm_litho_raster, maxpixels = 8e+05) + geom_raster(aes(fill = factor(value))) +
    coord_equal() + labs(x = "Easting (m)", y = "Northing (m)", fill = "Lithology") + ggtitle("NM Lithology") +
    scale_fill_manual(values = cbPalette)
nm_litho_raster_plot

#---------- Write Raster Covariates by layer------------------------------------------------------------------
writeRaster(co_litho_raster.layer, "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO/lithology", bylayer=T, suffix=levels(co.glim$xx), format="GTiff", overwrite=T)
writeRaster(nm_litho_raster.layer, "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM/lithology", bylayer=T, suffix=levels(nm.glim$xx), format="GTiff", overwrite=T)

```

### WorldClim Climate Data
```{r eval=FALSE}
#set output folders
input_folder <- "/data/Global_Covariate_Layers/WorldClim/prec"
co.output_folder <-"/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO"
nm.output_folder <-"/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM"
# set working directory to input folder
setwd(input_folder)

s_srs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
co.t_srs <- crs(CO)
nm.t_srs <- crs(NM)
res = 250

prec.list <- mixedsort(list.files("/data/data2/data/Global_Covariate_Layers/WorldClim/prec/", pattern = "hdr.adf",
    recursive = TRUE, include.dirs = TRUE))
temp.list <- mixedsort(list.files("/data/data2/data/Global_Covariate_Layers/WorldClim/tmean/", pattern = "hdr.adf",
    recursive = TRUE, include.dirs = TRUE))
bio.list <- mixedsort(list.files("/data/data2/data/Global_Covariate_Layers/WorldClim/bio/", pattern = "hdr.adf",
    recursive = TRUE, include.dirs = TRUE))

#---------------------------------------------------------------------------------------------------------------------
# Colorado Palteau process #

#------ Precip processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/prec"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(prec.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(prec.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", prec.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(co.output_folder, "/", "Precip_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = co.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(CO_raster))),
        overwrite = TRUE)

}

#------ Temp processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/tmean"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(temp.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(temp.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", temp.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(co.output_folder, "/", "Temp_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = co.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(CO_raster))),
        overwrite = TRUE)

}

#------ Bio processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/bio"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(bio.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(bio.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", bio.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(co.output_folder, "/", "Bio_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = co.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(CO_raster))),
        overwrite = TRUE)
}

#---------------------------------------------------------------------------------------------------------------------
# Chihuahuan Desert process #

#------ Precip processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/prec"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(prec.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(prec.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", prec.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(nm.output_folder, "/", "Precip_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = nm.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(NM_raster))),
        overwrite = TRUE)
}

#------ Temp processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/tmean"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(temp.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(temp.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", temp.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(nm.output_folder, "/", "Temp_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = nm.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(NM_raster))),
        overwrite = TRUE)
}

#------ Bio processing --------#

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers/WorldClim/bio"
# set up temp files for output.vrt
output.vrt <- list()
for (i in 1:length(bio.list)) {
    output.vrt[[i]] <- paste(tempfile(), ".vrt", sep = "")
}

# foreach loop
foreach(i = 1:length(bio.list), .packages = c("gdalUtils", "sp")) %dopar% {
    gdalbuildvrt(paste0(input_folder, "/", bio.list[[i]], sep = ""), output.vrt = output.vrt[[i]], separate = FALSE,
        tileindex = TRUE, overwrite = TRUE, verbose = TRUE)
    gdalwarp(output.vrt[[i]], dstfile = paste0(nm.output_folder, "/", "Bio_M", "_", i, ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = nm.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(NM_raster))),
        overwrite = TRUE)
}

#-----------------------------------------------------------------------------------------------------------
#Wclim stacks
co.prec.stack <- stack(paste0(co.output_folder, "/", mixedsort(list.files(co.output_folder, pattern = "Precip_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)
co.temp.stack <- stack(paste0(co.output_folder, "/", mixedsort(list.files(co.output_folder, pattern = "Temp_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)
co.bio.stack <- stack(paste0(co.output_folder, "/", mixedsort(list.files(co.output_folder, pattern = "Bio_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)

nm.prec.stack <- stack(paste0(nm.output_folder, "/", mixedsort(list.files(nm.output_folder, pattern = "Precip_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)
nm.temp.stack <- stack(paste0(nm.output_folder, "/", mixedsort(list.files(nm.output_folder, pattern = "Temp_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)
nm.bio.stack <- stack(paste0(nm.output_folder, "/", mixedsort(list.files(nm.output_folder, pattern = "Bio_M", recursive = TRUE, include.dirs = TRUE))), bands = 1)

```

### GAMMA Data
```{r eval=FALSE}
#paths to GAMMA data
NAMrad_exp <- "/data/data2/data/GAMMA_DATA/NAMrad_exp/NAMrad_exp.flt"
NAMrad_K <- "/data/data2/data/GAMMA_DATA/NAMrad_K/NAMrad_K.flt"
NAMrad_Th <- "/data/data2/data/GAMMA_DATA/NAMrad_Th/NAMrad_Th.flt"
NAMrad_U <- "/data/data2/data/GAMMA_DATA/NAMrad_U/NAMrad_U.flt"

co.path.NAMrad <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO"
nm.path.NAMrad <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM"
s_srs = '+proj=tmerc +lat_0=0 +lon_0=-100 +k=0.926 +x_0=0 +y_0=0 +ellps=sphere +units=m +no_defs'
t_srs = crs(NM)
t_res = 250

gdalwarp(NAMrad_exp, dstfile=paste0(nm.path.NAMrad, "/", "NAMrad_exp", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(NM))), overwrite = TRUE)
gdalwarp(NAMrad_K, dstfile=paste0(nm.path.NAMrad, "/", "NAMrad_K", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(NM))), overwrite = TRUE)
gdalwarp(NAMrad_Th, dstfile=paste0(nm.path.NAMrad, "/", "NAMrad_Th", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(NM))), overwrite = TRUE)
gdalwarp(NAMrad_U, dstfile=paste0(nm.path.NAMrad, "/", "NAMrad_U", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(NM))), overwrite = TRUE)
t_srs = crs(CO)
gdalwarp(NAMrad_exp, dstfile=paste0(co.path.NAMrad, "/", "NAMrad_exp", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(CO))), overwrite = TRUE)
gdalwarp(NAMrad_K, dstfile=paste0(co.path.NAMrad, "/", "NAMrad_K", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(CO))), overwrite = TRUE)
gdalwarp(NAMrad_Th, dstfile=paste0(co.path.NAMrad, "/", "NAMrad_Th", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(CO))), overwrite = TRUE)
gdalwarp(NAMrad_U, dstfile=paste0(co.path.NAMrad, "/", "NAMrad_U", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),te = c(as.vector(bbox(CO))), overwrite = TRUE)

co.namrad.stack <- stack(paste0(co.path.NAMrad, "/", mixedsort(list.files(co.path.NAMrad, pattern = "NAMrad", recursive = TRUE, include.dirs = TRUE))), bands = 1)
nm.namrad.stack <- stack(paste0(nm.path.NAMrad, "/", mixedsort(list.files(nm.path.NAMrad, pattern = "NAMrad", recursive = TRUE, include.dirs = TRUE))), bands = 1)
```

### Soil-Sediment Thickness
```{r eval=FALSE}
### Sed Thickness###
soil_thick <- raster("/data/data2/data/Global_Covariate_Layers/average_soil_and_sedimentary_deposit_thickness.tif")

# set output folders
s_srs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
co.t_srs <- projection(CO)
nm.t_srs <- projection(NM)
res = 250
sedThick <- list.files("/data/data2/data/Global_Covariate_Layers/", pattern = "thickness.tif", recursive = TRUE,
    include.dirs = TRUE)

# set input folder
input_folder <- "/data/data2/data/Global_Covariate_Layers"
co.output_folder <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO"
nm.output_folder <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM"

# extract and reproject
gdalwarp(paste0(input_folder, "/", sedThick, sep = ""), dstfile = paste0(co.output_folder, "/", "soil_thick", ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = co.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(CO))),
        overwrite = TRUE)

CO_soil_thick <- raster("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO/soil_thick.tif")


### NM set up temp files for output.vrt
gdalwarp(paste0(input_folder, "/", sedThick, sep = ""), dstfile = paste0(nm.output_folder, "/", "soil_thick", ".tif"), of = "GTiff",
        s_srs = s_srs, t_srs = nm.t_srs, tr = c(res, res), r = "bilinear", dstalpha = TRUE, te = c(as.vector(bbox(NM))),
        overwrite = TRUE)

NM_soil_thick <- raster("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM/soil_thick.tif")

```

### Soil Grids (250-m)
```{r eval=FALSE}
#-----------------------------------------------------------------------------------------------------------
# Loading 250m Soil Grids points extracted from downloaded raster layers
# CO Points
nasis35_ESGs_SoilGrids250vars.geo <- ogrListLayers("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/SoilGrids250_points/nasis35_ESGs_SoilGrids250vars.gpkg")
nasis35_ESGs_SoilGrids250vars.geo <- readOGR("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/SoilGrids250_points/nasis35_ESGs_SoilGrids250vars.gpkg", nasis35_ESGs_SoilGrids250vars.geo[1])
nasis35_ESGs_SoilGrids250vars.geo.edit <- nasis35_ESGs_SoilGrids250vars.geo[co.nasis@data$ESG_number != 0, ]

# Project using spTransform
nasis35_ESGs_SoilGrids250vars.points <- spTransform(nasis35_ESGs_SoilGrids250vars.geo.edit, crs(CO))
nasis35_ESGs_SoilGrids250vars.points@data$ESG_ID <- paste0("ES", nasis35_ESGs_SoilGrids250vars.points$ESG_number)
nasis35_ESGs_SoilGrids250vars.point.data <- nasis35_ESGs_SoilGrids250vars.points@data[13:100]

# NM Points
nasis42_ESGs_SoilGrids250vars.geo <- ogrListLayers("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/SoilGrids250_points/nasis42_ESDs_SoilGrids250vars.gpkg")
nasis42_ESGs_SoilGrids250vars.geo <- readOGR("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/SoilGrids250_points/nasis42_ESDs_SoilGrids250vars.gpkg", nasis42_ESGs_SoilGrids250vars.geo[1])
nasis42_ESGs_SoilGrids250vars.geo.edit <- nasis42_ESGs_SoilGrids250vars.geo[is.na(nm.nasis@data$First_ecoc) == FALSE, ]

#Subset points based on missing ESGs
# remove: 'Basalt Hill, Mixed Prairie', 'Gyp Breaks, Desert Grassland', 'Arroyo, Hot Desert Shrub'
nasis42_ESGs_SoilGrids250vars.geo.edit <- nasis42_ESGs_SoilGrids250vars.geo.edit[nasis42_ESGs_SoilGrids250vars.geo.edit@data$First_ecoc !=
    "Basalt Hill, Mixed Prairie", ]
nasis42_ESGs_SoilGrids250vars.geo.edit <- nasis42_ESGs_SoilGrids250vars.geo.edit[nasis42_ESGs_SoilGrids250vars.geo.edit@data$First_ecoc !=
    "Gyp Breaks, Desert Grassland", ]
nasis42_ESGs_SoilGrids250vars.geo.edit <- nasis42_ESGs_SoilGrids250vars.geo.edit[nasis42_ESGs_SoilGrids250vars.geo.edit@data$First_ecoc !=
    "Arroyo, Hot Desert Shrub", ]

nasis42_ESGs_SoilGrids250vars.points <- spTransform(nasis42_ESGs_SoilGrids250vars.geo.edit, crs(NM))
nasis42_ESGs_SoilGrids250vars.points@data$ESG_ID <- paste0("ES", nasis42_ESGs_SoilGrids250vars.points$ESG_mun)
nasis42_ESGs_SoilGrids250vars.point.data <- nasis42_ESGs_SoilGrids250vars.points@data[11:98]

#-----------------------------------------------------------------------------------------------------------
# Code to download SoilGrids250 via WebServices
required.packages <- c("RCurl","rgdal","GSIF","raster","plotKML","XML","lattice","aqp","soiltexture","MODIS", "doParallel", "foreach")
new.packages <- required.packages[!(required.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(required.packages, require, character.only=T)
rm(required.packages, new.packages)

# Set up parrallel backend
cluster <- makeCluster(24)
registerDoParallel(cluster)
getDoParWorkers()

if(.Platform$OS.type == "windows"){
   gdal.dir <- shortPathName("C:/Program files/GDAL")
   gdal_translate <- paste0(gdal.dir, "/gdal_translate.exe")
   gdalwarp <- paste0(gdal.dir, "/gdalwarp.exe")
   gdalinfo <- paste0(gdal.dir, "/gdalinfo.exe")
 } else {
   gdal_translate = "gdal_translate"
   gdalwarp = "gdalwarp"
   gdalinfo = "gdalinfo"
 }

#get list of SoilGrids250 variable names from previous point dataset
var.name <- substr(names(nasis42_ESGs_SoilGrids250vars.point.data), 1,nchar(names(nasis42_ESGs_SoilGrids250vars.point.data))-3)

# Project using spTransform
CO.proj <- spTransform(CO, crs("+proj=longlat +datum=WGS84"))
NM.proj <- spTransform(NM, crs("+proj=longlat +datum=WGS84"))
te.co = as.vector(CO.proj@bbox)
te.nm = as.vector(NM.proj@bbox)

bb <- matrix(nrow=2, c(-180,-62.00081,179.9999,87.37))
o.x.co = 172800 + round(172800*(te.co[1]-bb[1,2])/(bb[1,2]-bb[1,1]))
o.y.co = round(71698*(bb[2,2]-te.co[4])/(bb[2,2]-bb[2,1]))
d.y.co = round(71698*(te.co[4]-te.co[2])/(bb[2,2]-bb[2,1]))
d.x.co = round(172800*(te.co[3]-te.co[1])/(bb[1,2]-bb[1,1]))

o.x.nm = 172800 + round(172800*(te.nm[1]-bb[1,2])/(bb[1,2]-bb[1,1]))
o.y.nm = round(71698*(bb[2,2]-te.nm[4])/(bb[2,2]-bb[2,1]))
d.y.nm = round(71698*(te.nm[4]-te.nm[2])/(bb[2,2]-bb[2,1]))
d.x.nm = round(172800*(te.nm[3]-te.nm[1])/(bb[1,2]-bb[1,1]))

#Change wd
setwd("/data/data2/data/Global_Covariate_Layers/SoilGrids250")
wcs = "http://data.isric.org/geoserver/sg250m/wcs?"

# Extract SoilGrids250 for CO-Pat study area
for(i in 1:length(var.name)){
  t1 <- newXMLNode("WCS_GDAL")
  t1.s <- newXMLNode("ServiceURL", wcs, parent=t1)
  t1.l <- newXMLNode("CoverageName", var.name[i], parent=t1)
  xml.out <- paste(var.name[i], ".xml", sep="")
  saveXML(t1, file=xml.out)
  f.name <- paste(var.name[i], "_CO.tif", sep="")
  if(!file.exists(f.name)){
    system(paste0(gdal_translate, ' ', xml.out, ' ', f.name,  ' -co \"COMPRESS=DEFLATE\" -projwin ', paste(c(te.co[1], te.co[4],te.co[3], te.co[2]), collapse=" ")))
  }
 }

# Extract SoilGrids250 for NM-Chihuahaun study area
for(i in 1:length(var.name)){
  t1 <- newXMLNode("WCS_GDAL")
  t1.s <- newXMLNode("ServiceURL", wcs, parent=t1)
  t1.l <- newXMLNode("CoverageName", var.name[i], parent=t1)
  xml.out <- paste(var.name[i], ".xml", sep="")
  saveXML(t1, file=xml.out)
  f.name <- paste(var.name[i], "_NM.tif", sep="")
  if(!file.exists(f.name)){
   system(paste0(gdal_translate, ' ', xml.out, ' ', f.name, ' -co \"COMPRESS=DEFLATE\" -projwin ', paste(c(te.nm[1], te.nm[4],te.nm[3], te.nm[2]), collapse=" ")))
  }
}


path.soilgrids <- "/data/data2/data/Global_Covariate_Layers/SoilGrids250"

# CO SoilGrids250
soil.grids.co <- preStack(path = path.soilgrids, pattern = "*_CO.tif$")
soil.grids.co.list <- unstack(stack(soil.grids.co))

# NM SoilGrids250
soil.grids.nm <- preStack(path = path.soilgrids, pattern = "*_NM.tif$")
soil.grids.nm.list <- unstack(stack(soil.grids.nm))

s_srs = crs(soil.grids.co.list[[1]])
t_srs = crs(CO)
t_res = 250
resample_method = "average"
#get data types
co.data.types <- seq(1, length(soil.grids.co.list), 1)
for(i in 1:length(soil.grids.co.list)){
  co.data.types[i] <- dataType(soil.grids.co.list[[i]])
}
nm.data.types <- seq(1, length(soil.grids.nm.list), 1)
for(i in 1:length(soil.grids.nm.list)){
  nm.data.types[i] <- dataType(soil.grids.nm.list[[i]])
}
# INT1S	= Int8
# INT1U	= UInt8
# INT2S	= Int16
# INT2U	= UInt16
# INT4S	= Int32
# INT4U	= UInt32
#function to convert raster data types to GDAL data types
data.type.convert <- function(datatype){
  datatype.mod <- datatype
  for(i in 1:length(datatype)){
        if (datatype[i]=="INT1S") {
      datatype.mod[i] <- "Byte"
    } else if (datatype[i]=="INT1U") {
      datatype.mod[i] <- "Byte"
    } else if (datatype[i]=="INT2S") {
      datatype.mod[i] <- "Int16"
    } else if (datatype[i]=="INT2U") {
      datatype.mod[i] <- "UInt16"
    } else if (datatype[i]=="INT4S") {
      datatype.mod[i] <- "Int32"
    } else {
      datatype.mod[i] <- "UInt32"
    }
  }
  return(datatype.mod)
}

nm.data.types.mod <- data.type.convert(nm.data.types)
co.data.types.mod <- data.type.convert(co.data.types)

foreach(i = 1:length(soil.grids.nm), .packages = c("gdalUtils", "sp")) %dopar% {
          gdalwarp(soil.grids.nm[[i]], dstfile=paste0(path.soilgrids, "/", unique(substr(basename(soil.grids.nm[[i]]), 1,
            nchar(basename(soil.grids.nm[[i]]))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            r = resample_method, ot = nm.data.types.mod[i], te = c(as.vector(bbox(NM))), overwrite = TRUE)
}

foreach(i = 1:length(soil.grids.co), .packages = c("gdalUtils", "sp")) %dopar% {
          gdalwarp(soil.grids.co[[i]], dstfile=paste0(path.soilgrids, "/", unique(substr(basename(soil.grids.co[[i]]), 1,
            nchar(basename(soil.grids.co[[i]]))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            r = resample_method, ot = co.data.types.mod[i],te = c(as.vector(bbox(CO))), overwrite = TRUE)
}

# CO SoilGrids250
soil.grids.co.proj <- preStack(path = path.soilgrids, pattern = "*_CO_proj.tif$")
soil.grids.co.proj.list <- unstack(stack(soil.grids.co.proj))
soil.grids.co.proj.stack <- stack(soil.grids.co.proj)

# NM SoilGrids250
soil.grids.nm.proj <- preStack(path = path.soilgrids, pattern = "*_NM_proj.tif$")
soil.grids.nm.proj.list <- unstack(stack(soil.grids.nm.proj))
soil.grids.nm.proj.stack <- stack(soil.grids.nm.proj)

#---------- Write Raster Covariates by layer----------------------------------------------------------------
setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO")
writeRaster(soil.grids.co.proj.stack, filename = var.name, bylayer=T, format="GTiff", overwrite=T)
setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM")
writeRaster(soil.grids.nm.proj.stack, filename = var.name, bylayer=T, format="GTiff", overwrite=T)
#-----------------------------------------------------------------------------------------------------------
```

### GEE Monthly RS Rasters
```{r eval=FALSE}
path.gee <- "/data/data2/data/ESG_GEE"

#--------NM GEE layers
nm.ndvi.gee <- preStack(path = path.gee, pattern = "NM_NDVI_monthly_MeanStd.tif")
nm.mir.gee <- preStack(path = path.gee, pattern = "NM_MIR_monthly_MeanStd.tif")
nm.lst.day.gee <- preStack(path = path.gee, pattern = "NM_LST_Day_monthly_MeanStd.tif")
nm.lst.night.gee <- preStack(path = path.gee, pattern = "NM_LST_Night_monthly_MeanStd.tif")

nm.ndvi.gee.brick <- brick(nm.ndvi.gee)
nm.mir.gee.brick <- brick(nm.mir.gee)
nm.lst.day.gee.brick <- brick(nm.lst.day.gee)
nm.lst.night.gee.brick <- brick(nm.lst.night.gee)

s_srs = crs(nm.ndvi.gee.brick[[1]])
t_srs = crs(NM)
t_res = 250

          gdalwarp(nm.ndvi.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(nm.ndvi.gee), 1,
            nchar(basename(nm.ndvi.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(NM))), overwrite = TRUE)

          gdalwarp(nm.mir.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(nm.mir.gee), 1,
            nchar(basename(nm.mir.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(NM))), overwrite = TRUE)

          gdalwarp(nm.lst.day.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(nm.lst.day.gee), 1,
            nchar(basename(nm.lst.day.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(NM))), overwrite = TRUE)

          gdalwarp(nm.lst.night.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(nm.lst.night.gee), 1,
            nchar(basename(nm.lst.night.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(NM))), overwrite = TRUE)

nm.ndvi.gee.proj <- preStack(path = path.gee, pattern = ".*NM_NDVI.*_proj")
nm.mir.gee.proj <- preStack(path = path.gee, pattern = ".*NM_MIR.*_proj")
nm.lst.day.gee.proj <- preStack(path = path.gee, pattern = ".*NM_LST_Day.*_proj")
nm.lst.night.gee.proj <- preStack(path = path.gee, pattern = ".*NM_LST_Night.*_proj")
nm.ndvi.gee.proj.brick <- brick(nm.ndvi.gee.proj)
nm.mir.gee.proj.brick <- brick(nm.mir.gee.proj)
nm.lst.day.gee.proj.brick <- brick(nm.lst.day.gee.proj)
nm.lst.night.gee.proj.brick <- brick(nm.lst.night.gee.proj)

names(nm.ndvi.gee.proj.brick) <- c('NDVI_Jan_Mean','NDVI_Jan_Std','NDVI_Feb_Mean','NDVI_Feb_Std','NDVI_Mar_Mean','NDVI_Mar_Std',
  'NDVI_Apr_Mean','NDVI_Apr_Std','NDVI_May_Mean','NDVI_May_Std','NDVI_Jun_Mean','NDVI_Jun_Std',
  'NDVI_Jul_Mean','NDVI_Jul_Std','NDVI_Aug_Mean','NDVI_Aug_Std','NDVI_Sep_Mean','NDVI_Sep_Std',
  'NDVI_Oct_Mean','NDVI_Oct_Std','NDVI_Nov_Mean','NDVI_Nov_Std','NDVI_Dec_Mean','NDVI_Dec_Std')
names(nm.mir.gee.proj.brick ) <- c('MIR_Jan_Mean','MIR_Jan_Std','MIR_Feb_Mean','MIR_Feb_Std','MIR_Mar_Mean','MIR_Mar_Std',
  'MIR_Apr_Mean','MIR_Apr_Std','MIR_May_Mean','MIR_May_Std','MIR_Jun_Mean','MIR_Jun_Std',
  'MIR_Jul_Mean','MIR_Jul_Std','MIR_Aug_Mean','MIR_Aug_Std','MIR_Sep_Mean','MIR_Sep_Std',
  'MIR_Oct_Mean','MIR_Oct_Std','MIR_Nov_Mean','MIR_Nov_Std','MIR_Dec_Mean','MIR_Dec_Std')
names(nm.lst.day.gee.proj.brick) <- c('LST_Day_Jan_Mean','LST_Day_Jan_Std','LST_Day_Feb_Mean','LST_Day_Feb_Std','LST_Day_Mar_Mean','LST_Day_Mar_Std',
  'LST_Day_Apr_Mean','LST_Day_Apr_Std','LST_Day_May_Mean','LST_Day_May_Std','LST_Day_Jun_Mean','LST_Day_Jun_Std',
  'LST_Day_Jul_Mean','LST_Day_Jul_Std','LST_Day_Aug_Mean','LST_Day_Aug_Std','LST_Day_Sep_Mean','LST_Day_Sep_Std',
  'LST_Day_Oct_Mean','LST_Day_Oct_Std','LST_Day_Nov_Mean','LST_Day_Nov_Std','LST_Day_Dec_Mean','LST_Day_Dec_Std')
names(nm.lst.night.gee.proj.brick) <- c('LST_Night_Jan_Mean','LST_Night_Jan_Std','LST_Night_Feb_Mean','LST_Night_Feb_Std','LST_Night_Mar_Mean','LST_Night_Mar_Std',
  'LST_Night_Apr_Mean','LST_Night_Apr_Std','LST_Night_May_Mean','LST_Night_May_Std','LST_Night_Jun_Mean','LST_Night_Jun_Std',
  'LST_Night_Jul_Mean','LST_Night_Jul_Std','LST_Night_Aug_Mean','LST_Night_Aug_Std','LST_Night_Sep_Mean','LST_Night_Sep_Std',
  'LST_Night_Oct_Mean','LST_Night_Oct_Std','LST_Night_Nov_Mean','LST_Night_Nov_Std','LST_Night_Dec_Mean','LST_Night_Dec_Std')

#--------CO GEE layers
co.ndvi.gee <- preStack(path = path.gee, pattern = "^CO_NDVI_monthly_MeanStd.tif")
co.mir.gee <- preStack(path = path.gee, pattern = "^CO_MIR_monthly_MeanStd.tif")
co.lst.day.gee <- preStack(path = path.gee, pattern = "^CO_LST_Day_monthly_MeanStd.tif")
co.lst.night.gee <- preStack(path = path.gee, pattern = "^CO_LST_Night_monthly_MeanStd.tif")
co.ndvi.gee.brick <- brick(co.ndvi.gee)
co.mir.gee.brick <- brick(co.mir.gee)
co.lst.day.gee.brick <- brick(co.lst.day.gee)
co.lst.night.gee.brick <- brick(co.lst.night.gee)


s_srs = crs(co.ndvi.gee.brick[[1]])
t_srs = crs(CO)
t_res = 250

          gdalwarp(co.ndvi.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(co.ndvi.gee), 1,
            nchar(basename(co.ndvi.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(CO))), overwrite = TRUE)

          gdalwarp(co.mir.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(co.mir.gee), 1,
            nchar(basename(co.mir.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(CO))), overwrite = TRUE)

          gdalwarp(co.lst.day.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(co.lst.day.gee), 1,
            nchar(basename(co.lst.day.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(CO))), overwrite = TRUE)

          gdalwarp(co.lst.night.gee[[i]], dstfile=paste0(path.gee, "/", unique(substr(basename(co.lst.night.gee), 1,
            nchar(basename(co.lst.night.gee))-4)), "_proj", ".tif"), of = "GTiff", s_srs = s_srs, t_srs = t_srs, tr = c(t_res, t_res),
            te = c(as.vector(bbox(CO))), overwrite = TRUE)

co.ndvi.gee.proj <- preStack(path = path.gee, pattern = ".*CO_NDVI.*_proj")
co.mir.gee.proj <- preStack(path = path.gee, pattern = ".*CO_MIR.*_proj")
co.lst.day.gee.proj <- preStack(path = path.gee, pattern = ".*CO_LST_Day.*_proj")
co.lst.night.gee.proj <- preStack(path = path.gee, pattern = ".*CO_LST_Night.*_proj")
co.ndvi.gee.proj.brick <- brick(co.ndvi.gee.proj)
co.mir.gee.proj.brick <- brick(co.mir.gee.proj)
co.lst.day.gee.proj.brick <- brick(co.lst.day.gee.proj)
co.lst.night.gee.proj.brick <- brick(co.lst.night.gee.proj)

names(co.ndvi.gee.proj.brick) <- c('NDVI_Jan_Mean','NDVI_Jan_Std','NDVI_Feb_Mean','NDVI_Feb_Std','NDVI_Mar_Mean','NDVI_Mar_Std',
  'NDVI_Apr_Mean','NDVI_Apr_Std','NDVI_May_Mean','NDVI_May_Std','NDVI_Jun_Mean','NDVI_Jun_Std',
  'NDVI_Jul_Mean','NDVI_Jul_Std','NDVI_Aug_Mean','NDVI_Aug_Std','NDVI_Sep_Mean','NDVI_Sep_Std',
  'NDVI_Oct_Mean','NDVI_Oct_Std','NDVI_Nov_Mean','NDVI_Nov_Std','NDVI_Dec_Mean','NDVI_Dec_Std')
names(co.mir.gee.proj.brick) <- c('MIR_Jan_Mean','MIR_Jan_Std','MIR_Feb_Mean','MIR_Feb_Std','MIR_Mar_Mean','MIR_Mar_Std',
  'MIR_Apr_Mean','MIR_Apr_Std','MIR_May_Mean','MIR_May_Std','MIR_Jun_Mean','MIR_Jun_Std',
  'MIR_Jul_Mean','MIR_Jul_Std','MIR_Aug_Mean','MIR_Aug_Std','MIR_Sep_Mean','MIR_Sep_Std',
  'MIR_Oct_Mean','MIR_Oct_Std','MIR_Nov_Mean','MIR_Nov_Std','MIR_Dec_Mean','MIR_Dec_Std')
names(co.lst.day.gee.proj.brick) <- c('LST_Day_Jan_Mean','LST_Day_Jan_Std','LST_Day_Feb_Mean','LST_Day_Feb_Std','LST_Day_Mar_Mean','LST_Day_Mar_Std',
  'LST_Day_Apr_Mean','LST_Day_Apr_Std','LST_Day_May_Mean','LST_Day_May_Std','LST_Day_Jun_Mean','LST_Day_Jun_Std',
  'LST_Day_Jul_Mean','LST_Day_Jul_Std','LST_Day_Aug_Mean','LST_Day_Aug_Std','LST_Day_Sep_Mean','LST_Day_Sep_Std',
  'LST_Day_Oct_Mean','LST_Day_Oct_Std','LST_Day_Nov_Mean','LST_Day_Nov_Std','LST_Day_Dec_Mean','LST_Day_Dec_Std')
names(co.lst.night.gee.proj.brick) <- c('LST_Night_Jan_Mean','LST_Night_Jan_Std','LST_Night_Feb_Mean','LST_Night_Feb_Std','LST_Night_Mar_Mean','LST_Night_Mar_Std',
  'LST_Night_Apr_Mean','LST_Night_Apr_Std','LST_Night_May_Mean','LST_Night_May_Std','LST_Night_Jun_Mean','LST_Night_Jun_Std',
  'LST_Night_Jul_Mean','LST_Night_Jul_Std','LST_Night_Aug_Mean','LST_Night_Aug_Std','LST_Night_Sep_Mean','LST_Night_Sep_Std',
  'LST_Night_Oct_Mean','LST_Night_Oct_Std','LST_Night_Nov_Mean','LST_Night_Nov_Std','LST_Night_Dec_Mean','LST_Night_Dec_Std')


#---------- Write Raster Covariates by layer------------------------------------------------------------------
setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO")
writeRaster(co.ndvi.gee.proj.brick, filename = names(co.ndvi.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(co.mir.gee.proj.brick, filename = names(co.mir.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(co.lst.day.gee.proj.brick, filename = names(co.lst.day.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(co.lst.night.gee.proj.brick, filename = names(co.lst.night.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)

setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM")
writeRaster(nm.ndvi.gee.proj.brick, filename = names(nm.ndvi.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(nm.mir.gee.proj.brick, filename = names(nm.mir.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(nm.lst.day.gee.proj.brick, filename = names(nm.lst.day.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
writeRaster(nm.lst.night.gee.proj.brick, filename = names(nm.lst.night.gee.proj.brick), bylayer=T, format="GTiff", overwrite=T)
```

### Landcover
```{r eval=FALSE}
#-----------------------------------------------------------------------------------------------------------
#------Landcover classes
# Water, Evergreen Needleleaf forest, Evergreen Broadleaf forest, Deciduous Needleleaf forest, Deciduous
# Broadleaf forest, Mixed forest, Closed shrublands, Open shrublands, Woody savannas, Savannas, Grasslands,
# Permanent wetlands, Croplands, Urban, Cropland/Natural vegetation mosaic, Snow and ice, Barren or
# sparsely vegetated, Unclassified, Fill Value

land.class <- data.table(rbind(c(0, "WA"), c(1, "ENF"), c(2, "EBF"), c(3, "DNF"), c(4, "DBF"), c(5, "MF"),
    c(6, "CS"), c(7, "OS"), c(8, "WS"), c(9, "SA"), c(10, "GR"), c(11, "PW"), c(12, "CR"), c(13, "UR"),
    c(14, "CNVM"), c(15, "SI"), c(16, "BSV"), c(254, "UN"), c(255, "FV")))

names(land.class) <- c("ID", "Cover")
land.class <- data.frame(land.class)
land.class$ID <- as.numeric(land.class$ID)
#-----------------------------------------------------------------------------------------------------------

#Load in Landcover raster layer created in ESG_Mapping_CO_NM_MODIS_HyperTemp_Process.R script
### Landcover Raster Layers
co_landcover_raster.layer <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_Landcover_500M/CO_landcover_layers.tif")
names(co_landcover_raster.layer) <- paste0("Cover_", land.class[, 2])

nm_landcover_raster.layer <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_Landcover_500M/NM_landcover_layers.tif")
names(nm_landcover_raster.layer) <- paste0("Cover_", land.class[, 2])

setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO")
writeRaster(co_landcover_raster.layer, filename = names(co_landcover_raster.layer), bylayer=T, format="GTiff", overwrite=T)
setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM")
writeRaster(nm_landcover_raster.layer, filename = names(nm_landcover_raster.layer), bylayer=T, format="GTiff", overwrite=T)
```

### Hyper-temporal Imagery
```{r eval=FALSE}
CO_infill.ndvi <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_VI_250M/CO_NDVI_infill.tif")
CO_infill.evi <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_VI_250M/CO_EVI_infill.tif")
CO_infill.vi.red <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_VI_250M/CO_VI_RED_infill.tif")
CO_infill.vi.swir2 <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_VI_250M/CO_VI_SWIR2_infill.tif")
CO_LST_Day_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_LST_1000M/CO_LST_Day_infill.tif")
CO_LST_Night_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_LST_1000M/CO_LST_Night_infill.tif")

NM_infill.ndvi <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_VI_250M/NM_NDVI_infill.tif")
NM_infill.evi <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_VI_250M/NM_EVI_infill.tif")
NM_infill.vi.red <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_VI_250M/NM_VI_RED_infill.tif")
NM_infill.vi.swir2 <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_VI_250M/NM_VI_SWIR2_infill.tif")
NM_LST_Day_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_LST_1000M/NM_LST_Day_infill.tif")
NM_LST_Night_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_LST_1000M/NM_LST_Night_infill.tif")

#BRDF infill layers for CO and NM
CO_SWIR1_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_Modis_BRDF/CO_SWIR1_infill.tif")
CO_SATVI_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/CO_VI_250M/CO_SATVI_Infill.tif")
NM_SWIR1_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_Modis_BRDF/NM_SWIR1_infill.tif")
NM_SATVI_infill <- brick("/data/data2/data/MODIS/MODIS_ARC/PROCESSES/NM_VI_250M/NM_SATVI_Infill.tif")

#set names
hype.ndvi.names <- paste0("NDVI", seq(1, 393, 1))
hype.swir2.names <- paste0("MIR", seq(1, 393, 1))
hype.lst_day.names <- paste0("LST_day", seq(1, 392, 1))
hype.lst_night.names <- paste0("LST_night", seq(1, 392, 1))

rasterWritePar <- function(s, name.list){
foreach(i = 1:nlayers(s), .packages = c("raster")) %dopar% {
  r <- raster::raster(s, i)
  raster::writeRaster(r, filename = name.list[i], bylayer=T, format="GTiff", overwrite=T)
  rm(r)
}}


setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/CO")
rasterWritePar(CO_infill.ndvi, hype.ndvi.names)
rasterWritePar(CO_infill.vi.swir2, hype.swir2.names)
rasterWritePar(CO_LST_Day_infill, hype.lst_day.names)
rasterWritePar(CO_LST_Night_infill, hype.lst_night.names)

setwd("/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/NM")
rasterWritePar(NM_infill.ndvi, hype.ndvi.names)
rasterWritePar(NM_infill.vi.swir2, hype.swir2.names)
rasterWritePar(NM_LST_Day_infill, hype.lst_day.names)
rasterWritePar(NM_LST_Night_infill, hype.lst_night.names)

#LST files were not previously masked with GDAL, while NDVI and MIR were. Mask LST layers
co.hyper.path <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/CO"
co.hyper.premask.path <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/CO/premask"
co.hyper.premask <- preStack(path = co.hyper.premask.path, pattern = ".*.tif")
co.hyper.premask.list <- unstack(stack(co.hyper.premask, bands=1))

foreach(i = 1:length(co.hyper.premask.list), .packages = c("raster"), .export=c("fill.na", "mask.fill")) %dopar% {
    writeRaster(mask.fill(co.hyper.premask.list[[i]], CO_raster), filename = paste0(co.hyper.path, "/", names(co.hyper.premask.list[[i]])), bylayer=T, format="GTiff", overwrite=T)
}

nm.hyper.path <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/NM"
nm.hyper.premask.path <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_hyper/NM/premask"
nm.hyper.premask <- preStack(path = nm.hyper.premask.path, pattern = ".*.tif")
nm.hyper.premask.list <- unstack(stack(nm.hyper.premask, bands=1))

foreach(i = 1:length(nm.hyper.premask.list), .packages = c("raster"), .export=c("fill.na", "mask.fill")) %dopar% {
    writeRaster(mask.fill(nm.hyper.premask.list[[i]], NM_raster), filename = paste0(nm.hyper.path, "/", names(nm.hyper.premask.list[[i]])), bylayer=T, format="GTiff", overwrite=T)
}

#prestack hyper layers now that all have been masked
co.hyper <- preStack(path = co.hyper.path, pattern = ".*.tif")
nm.hyper <- preStack(path = nm.hyper.path, pattern = ".*.tif")
```

## Align Raster Extents
```{r eval=FALSE}
#-------------------Functions for aligning extent, infilling and masking
#Function to crop list of raster layers to common extent
cFun <- function(filelist, ext) {
    imageStack <- list()
    for (i in 1:length(filelist)) {
        imageStack[[i]] <- crop(raster(filelist[i]), ext)
    }
    rs <- stack(imageStack, quick = TRUE)
    return(rs)
}

#Functions to fill missing values in incomplete raster covariate layers
fill.na <- function(x, i=13) {
  if( is.na(x)[i] ) {
    return( round(mean(x, na.rm=TRUE),0) )
  } else {
    return( round(x[i],0) )
  }
}

mask.fill <- function(raster, mask){
   r.masked <- mask(raster, mask, updatevalue = -9999, updateNA=FALSE)
   r.masked[r.masked == -32768] <- NA
   if(cellStats(is.na(r.masked), sum) != 0){
     r.masked.fill <- focal(r.masked, w = matrix(1,5,5), fun = fill.na,
            pad = TRUE, na.rm = FALSE, NAonly=TRUE)
     if(cellStats(is.na(r.masked.fill), sum) != 0){
       r.masked.fill2 <- focal(r.masked.fill, w = matrix(1,5,5), fun = fill.na,
            pad = TRUE, na.rm = FALSE, NAonly=TRUE)
       r.masked.fill2[r.masked.fill2 < -1000] <- NA
       return(r.masked.fill2)
     } else {
       r.masked.fill[r.masked.fill < -1000] <- NA
       return(r.masked.fill) }
   } else {
     r.masked[r.masked < -1000] <- NA
     return(r.masked) }
}

#--------------------------------------------------------------------------------------------
##------------- CO ---------------------------------------------
#Check that all covariate layers have common extent by creating stack
co.wd <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO"
co.covariates <- preStack(path = co.wd, pattern = ".*.tif")
co.covariates.stack <- stack(co.covariates, bands=1)

### ----------Fails to create stack----------------------
## Need to crop all covariate layers to study boundary
# create common extent for all covariate layers
x0 <- vector()
x1 <- vector()
y0 <- vector()
y1 <- vector()

for (i in 1:length(co.covariates)) {
    ex <- extent(raster(co.covariates[[i]]))
    x0[i] <- ex[1]
    x1[i] <- ex[2]
    y0[i] <- ex[3]
    y1[i] <- ex[4]
}
extCommon <- extent(max(x0), min(x1), max(y0), min(y1))

# create common extent for entire study area
co.covariates.extCommon <- cFun(filelist = co.covariates, ext = extCommon)
co.covariates.extCommon.list <- unstack(co.covariates.extCommon)

#files that were cropped to conform to new extent are saved in memory. Write out all files in memory back into covariate folder.
foreach(i = 1:length(co.covariates.extCommon.list), .packages = c("raster")) %dopar% {
  if(inMemory(co.covariates.extCommon.list[[i]])==TRUE){
   writeRaster(co.covariates.extCommon.list[[i]], filename = paste0(co.wd, "/", names(co.covariates.extCommon.list[[i]])), format="GTiff", overwrite=T)
  }
}

co.covariates.list <- unstack(stack(co.covariates, bands=1))

#now we will mask all files and write back to original forlder.
co.mask <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/CO_mask"
#now we will mask all files and write back to original forlder.
foreach(i = 1:length(co.covariates.list), .packages = c("raster"), .export=c("fill.na", "mask.fill")) %dopar% {
    writeRaster(mask.fill(co.covariates.list[[i]], CO_raster), filename = paste0(co.mask, "/", names(co.covariates.list[[i]])), bylayer=T, format="GTiff", overwrite=T)
}

co.covariates <- preStack(path = co.mask, pattern = ".*.tif")
co.covariates <- c(co.covariates, co.hyper)
co.covariates.stack <- stack(co.covariates)

#--------------------------------------------------------------------------------------------------------------
# NM #
#Check that all covariate layers have common extent by creating stack
nm.wd <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM"
nm.covariates <- preStack(path = nm.wd, pattern = ".*.tif")
nm.covariates.stack <- stack(nm.covariates, bands=1)

### ----------Fails to create stack----------------------
## Need to crop all covariate layers to study boundary
# create common extent for all covariate layers
x0 <- vector()
x1 <- vector()
y0 <- vector()
y1 <- vector()

for (i in 1:length(nm.covariates)) {
    ex <- extent(raster(nm.covariates[[i]]))
    x0[i] <- ex[1]
    x1[i] <- ex[2]
    y0[i] <- ex[3]
    y1[i] <- ex[4]
}
extCommon <- extent(max(x0), min(x1), max(y0), min(y1))

# create common extent for entire study area
nm.covariates.extCommon <- cFun(filelist = nm.covariates, ext = extCommon)
nm.covariates.extCommon.list <- unstack(nm.covariates.extCommon)

#files that were cropped to conform to new extent are saved in memory. Write out all files in memory back into covariate folder.
foreach(i = 1:length(nm.covariates.extCommon.list), .packages = c("raster")) %dopar% {
  if(inMemory(nm.covariates.extCommon.list[[i]])==TRUE){
   writeRaster(nm.covariates.extCommon.list[[i]], filename = paste0(nm.wd, "/", names(nm.covariates.extCommon.list[[i]])), format="GTiff", overwrite=T)
  }
  }
nm.covariates.list <- unstack(stack(nm.covariates, bands=1))

#now we will mask all files and write out to a new forlder.
nm.mask <- "/data/data2/data/esgMapping/analysis/data/derived_data/raster_covariates/NM_mask"

#now we will mask all files and write back to original forlder.
foreach(i = 1:length(nm.covariates.list), .packages = c("raster"), .export=c("fill.na", "mask.fill")) %dopar% {
    writeRaster(mask.fill(nm.covariates.list[[i]], NM_raster), filename = paste0(nm.mask, "/", names(nm.covariates.list[[i]])), bylayer=T, format="GTiff", overwrite=T)
}

nm.covariates <- preStack(path = nm.mask, pattern = ".*.tif")
nm.covariates <- c(nm.covariates, nm.hyper)
nm.covariates.stack <- stack(nm.covariates)
```

## Extract Point Data
```{r eval=FALSE}
#----------------------- Extract Point Covariate Data  --------------------------------------------------------
#extrating point from masked rasters causes ~110 points to contain NA values

# Method to extract pixel stacks at point locations
sfInit(parallel = TRUE, cpus = ncpus)
sfExport("co.points", "co.covariates", "nm.points", "nm.covariates")
sfLibrary(raster)
co.points.covariates <- sfLapply(co.covariates, function(i){try( raster::extract(raster(i), co.points) )})
nm.points.covariates <- sfLapply(nm.covariates, function(i){try( raster::extract(raster(i), nm.points) )})
sfStop()

co.points.covariates <- cbind(co.site_id, co.points.covariates)
names(co.points.covariates) <- c(names(co.site_id), names(co.covariates.stack))

nm.points.covariates <- cbind(nm.site_id, nm.points.covariates)
names(nm.points.covariates) <- c(names(nm.site_id), names(nm.covariates.stack))
nm.points.covariates <-nm.points.covariates[,-172:-175] #remove NAMrad data b/c large hole over White Sands.

co.spatial.points.cov <- co.points
co.spatial.points.cov@data <- co.points.covariates
nm.spatial.points.cov <- nm.points
nm.spatial.points.cov@data <- nm.points.covariates

#identity rows that contain missing values
co.na.index <- unique(as.data.frame(which(is.na(co.spatial.points.cov@data), arr.ind = TRUE))[, 1])
co.spatial.points.cov <- co.spatial.points.cov[-co.na.index, ]
nm.na.index <- unique(as.data.frame(which(is.na(nm.spatial.points.cov@data), arr.ind = TRUE))[, 1])
nm.spatial.points.cov <- nm.spatial.points.cov[-nm.na.index, ]

writeOGR(co.spatial.points.cov, dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="CO_points_cov_vals", driver="ESRI Shapefile", overwrite_layer = TRUE)
writeOGR(nm.spatial.points.cov, dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="NM_points_cov_vals", driver="ESRI Shapefile", overwrite_layer = TRUE)

#update point covariate data.tables to remove points with NAs
co.points.covariates <- co.spatial.points.cov@data
nm.points.covariates <- nm.spatial.points.cov@data
write.table(co.points.covariates, "/data/data2/data/esgMapping/analysis/data/derived_data/tables/CO_points_covariate_values.txt", sep = "\t", row.names = FALSE)
write.table(nm.points.covariates, "/data/data2/data/esgMapping/analysis/data/derived_data/tables/NM_points_covariate_values.txt", sep = "\t", row.names = FALSE)

#----------------list dataset names-------------------------------------
#Terrain
terrain.co.names
terrain.nm.names
#lithology
lithology.co.names <- names(co_litho_raster.layer)
lithology.nm.names <- names(nm_litho_raster.layer)
#wclim
prec.co.names <- names(co.prec.stack)
temp.co.names <- names(co.temp.stack)
bio.co.names <- names(co.bio.stack)
prec.nm.names <- names(nm.prec.stack)
temp.nm.names <- names(nm.temp.stack)
bio.nm.names <- names(nm.bio.stack)
#NAMrad
namrad.co.names <- names(co.namrad.stack)
#Soil thickness
soil.thick.co.names <- names(CO_soil_thick)
soil.thick.nm.names <- names(NM_soil_thick)
#soilGrids
soilGrids.co.names <-  var.name
soilGrids.nm.names <-  var.name
#GEE
ndvi.co.names <-  names(co.ndvi.gee.proj.brick)
mir.co.names <-  names(co.mir.gee.proj.brick)
lst.day.co.names <-  names(co.lst.day.gee.proj.brick)
lst.night.co.names <-  names(co.lst.night.gee.proj.brick)
ndvi.nm.names <-  names(nm.ndvi.gee.proj.brick)
mir.nm.names <-  names(nm.mir.gee.proj.brick)
lst.day.nm.names <-  names(nm.lst.day.gee.proj.brick)
lst.night.nm.names <-  names(nm.lst.night.gee.proj.brick)
#hyper
hype.ndvi.names <- paste0("NDVI", seq(1, 393, 1))
hype.swir2.names <- paste0("MIR", seq(1, 393, 1))
hype.lst_day.names <- paste0("LST_day", seq(1, 392, 1))
hype.lst_night.names <- paste0("LST_night", seq(1, 392, 1))

save( terrain.co.names, lithology.co.names, prec.co.names, temp.co.names, bio.co.names, namrad.co.names, soil.thick.co.names, soilGrids.co.names, ndvi.co.names, mir.co.names, lst.day.co.names, lst.night.co.names, hype.ndvi.names, hype.swir2.names, hype.lst_day.names, hype.lst_night.names, file = "/data/data2/data/esgMapping/R/co_covariate_names.Rdata")

save( terrain.nm.names, lithology.nm.names, prec.nm.names, temp.nm.names, bio.nm.names, soil.thick.nm.names, soilGrids.nm.names, ndvi.nm.names, mir.nm.names, lst.day.nm.names, lst.night.nm.names, hype.ndvi.names, hype.swir2.names, hype.lst_day.names, hype.lst_night.names, file = "/data/data2/data/esgMapping/R/nm_covariate_names.Rdata")
#------------------------------------------------------------------------------


#---------------External Cross-validation-------------------------------------------
## CO validation points
NM_cleaned_val_points <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/JRN_Validation_Data",
    layer = "CleanedValidationData")
NM_JRN_val_points <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/JRN_Validation_Data",
    layer = "JRN_esite_point_unique")

nm.lookup <- read.csv("/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/MLRA42_NASIS_ESG_lookup.csv",
    header = T)
nm.lookup <- nm.lookup[, c(1, 2, 6, 7)]
nm.lookup <- nm.lookup[!duplicated(nm.lookup), ]

NM_JRN_val_points.data <- NM_JRN_val_points@data
colnames(NM_JRN_val_points.data)[1] <- "Caiti_ecosites"
NM_JRN_val_points.data <- join(NM_JRN_val_points.data, nm.lookup, type = "inner")
colnames(NM_JRN_val_points.data)[6] <- "Group"
NM_JRN_val_points@data <- NM_JRN_val_points.data

NM_val1 <- NM_JRN_val_points
NM_val1.data <- data.frame(NM_JRN_val_points@data$Group)
colnames(NM_val1.data) <- "Group"
NM_val1@data <- NM_val1.data

NM_val2 <- NM_cleaned_val_points
NM_val2.data <- data.frame(NM_cleaned_val_points@data$Group)
colnames(NM_val2.data) <- "Group"
NM_val2@data <- NM_val2.data

NM_Validation_Final <- spTransform(spRbind(NM_val1, NM_val2), crs(NM))
writeOGR(NM_Validation_Final , dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="NM_ext_valid_points", driver="ESRI Shapefile")
nm_val.site_id <- paste0("ES", NM_Validation_Final$Group)
#----------------------------------------------------
## CO validation points
CO_Validation_Final <- readOGR(dsn = "/data/data1/R_DATA/Imagery_Vector/Ecosite_Group_Mapping/COPlat_Val_data",
    layer = "Miller_plots_trim_ESGs")
writeOGR(CO_Validation_Final , dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="CO_ext_valid_points", driver="ESRI Shapefile")
co_val.site_id <- paste0("ES", CO_Validation_Final$ESG_number)
#----------------------------------------------------

#Extract covariate data at external validation sites
sfInit(parallel = TRUE, cpus = ncpus)
sfExport("CO_Validation_Final", "co.covariates", "NM_Validation_Final", "nm.covariates")
sfLibrary(raster)
co.validation.points.covariates.extract <- sfLapply(co.covariates, function(i){try( raster::extract(raster(i), CO_Validation_Final) )})
nm.validation.points.covariates.extract <- sfLapply(nm.covariates, function(i){try( raster::extract(raster(i), NM_Validation_Final) )})
#sfStop()
co.validation.points.covariates <-  co.validation.points.covariates.extract
nm.validation.points.covariates <- nm.validation.points.covariates.extract
#create esite df with site index for validation datasets
co_val.site_id <- data.frame(seq(1,length(co_val.site_id),1), as.factor(co_val.site_id))
names(co_val.site_id) <- c("Index", "esite")

nm_val.site_id <- data.frame(seq(1,length(nm_val.site_id),1),as.factor(nm_val.site_id))
names(nm_val.site_id) <- c("Index", "esite")

co.validation.points.covariates <- cbind(co_val.site_id, co.validation.points.covariates)
names(co.validation.points.covariates) <- c(names(co_val.site_id), names(co.covariates.stack))

nm.validation.points.covariates <- cbind(nm_val.site_id, nm.validation.points.covariates)
names(nm.validation.points.covariates) <- c(names(nm_val.site_id), names(nm.covariates.stack))
nm.validation.points.covariates <-nm.validation.points.covariates[,-172:-175] #remove NAMrad data b/c large hole over White Sands.

#identity rows that contain missing values
co.val.na.index <- unique(as.data.frame(which(is.na(co.validation.points.covariates), arr.ind = TRUE))[, 1])
co.validation.points.covariates.narm <- co.validation.points.covariates[-co.val.na.index, ]
nm.val.na.index <- unique(as.data.frame(which(is.na(nm.validation.points.covariates), arr.ind = TRUE))[, 1])
nm.validation.points.covariates.narm <- nm.validation.points.covariates[-nm.val.na.index, ]

write.table(co.validation.points.covariates, "/data/data2/data/esgMapping/analysis/data/derived_data/tables/CO_validation_points_covariate_values.txt", sep = "\t", row.names = FALSE)
write.table(nm.validation.points.covariates.narm, "/data/data2/data/esgMapping/analysis/data/derived_data/tables/NM_validation_points_covariate_values.txt", sep = "\t", row.names = FALSE)


#Spatial point data
co.spatial.validation.points.cov <- CO_Validation_Final
co.spatial.validation.points.cov@data <- co.validation.points.covariates
nm.spatial.validation.points.cov <- NM_Validation_Final
nm.spatial.validation.points.cov@data <- nm.validation.points.covariates

#identity rows that contain missing values
co.val.na.index <- unique(as.data.frame(which(is.na(co.spatial.validation.points.cov@data), arr.ind = TRUE))[, 1])
#co.spatial.validation.points.cov <- co.spatial.points.cov[-co.val.na.index, ]
nm.val.na.index <- unique(as.data.frame(which(is.na(nm.spatial.validation.points.cov@data), arr.ind = TRUE))[, 1])
nm.spatial.validation.points.cov <- nm.spatial.validation.points.cov[-nm.val.na.index, ]

writeOGR(co.spatial.validation.points.cov , dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="CO_points_cov_vals", driver="ESRI Shapefile", overwrite_layer = TRUE)
writeOGR(nm.spatial.validation.points.cov , dsn="/data/data2/data/esgMapping/analysis/data/derived_data/vector_data/", layer="NM_points_cov_vals", driver="ESRI Shapefile", overwrite_layer = TRUE)

```

## Data Output
```{r eval=FALSE}
#------------------------------------------------------------------------------------------------
#Output data for modeling steps
save(co.points.covariates,co.spatial.points.cov, co.validation.points.covariates, co.spatial.validation.points.cov, co.covariates.stack, file = "/data/data2/data/esgMapping/R/CO_ESG_modeling_data.Rdata")

save(nm.points.covariates,nm.spatial.points.cov, nm.validation.points.covariates.narm, nm.spatial.validation.points.cov, nm.covariates.stack, file = "/data/data2/data/esgMapping/R/NM_ESG_modeling_data.Rdata")

#------------------------------------------------------------------------------------------------
save.image("/data/data2/data/esgMapping/R/CO_NM_Ecosite_covariate_process.RData")
load("/data/data2/data/esgMapping/R/CO_NM_Ecosite_covariate_process.RData")
#------------------------------------------------------------------------------------------------
```

